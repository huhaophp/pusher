<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>WebSocket å®¢æˆ·ç«¯ Demo</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        #log {
            background: #222;
            color: #eee;
            padding: 15px;
            height: 500px;
            overflow-y: scroll;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .log-line {
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #444;
        }

        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        .warning { color: #FFC107; }

        button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        #btnStart { background: #4CAF50; color: white; }
        #btnStop { background: #f44336; color: white; }
        #btnClear { background: #FFC107; color: black; }
        #btnReconnect { background: #2196F3; color: white; }

        .status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
        }

        .connected { background: #4CAF50; color: white; }
        .disconnected { background: #f44336; color: white; }
        .reconnecting { background: #FFC107; color: black; }
    </style>
</head>
<body>
<h2>ğŸš€ WebSocket å®¢æˆ·ç«¯ Demo</h2>
<div class="status disconnected">çŠ¶æ€: æœªè¿æ¥</div>

<div>
    <button id="btnStart" onclick="startClient()">å¯åŠ¨å®¢æˆ·ç«¯</button>
    <button id="btnStop" onclick="stopClient()">åœæ­¢å®¢æˆ·ç«¯</button>
    <button id="btnClear" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <button id="btnReconnect" onclick="simulateReconnect()">æ¨¡æ‹Ÿé‡è¿</button>
</div>

<p>è¿æ¥åœ°å€: <code id="wsUrl">ws://127.0.0.1:8081/ws</code></p>

<div id="log"></div>

<script>
    let ws = null;
    let pingInterval = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 3000; // 3ç§’é‡è¯•é—´éš”
    let clientId = Math.floor(Math.random() * 10000);
    let isManualDisconnect = false;

    function updateStatus(status, message = '') {
        const statusDiv = document.querySelector('.status');
        statusDiv.className = 'status ' + status;

        const statusText = {
            'connected': 'çŠ¶æ€: å·²è¿æ¥',
            'disconnected': 'çŠ¶æ€: å·²æ–­å¼€',
            'reconnecting': 'çŠ¶æ€: æ­£åœ¨é‡è¿...'
        };

        statusDiv.textContent = statusText[status] + (message ? ' - ' + message : '');
    }

    function log(message, type = 'info', data = null) {
        const div = document.createElement('div');
        div.className = `log-line ${type}`;
        const time = new Date().toLocaleTimeString();
        div.innerHTML = `<span class="timestamp">[${time}]</span> <span class="client-id">[Client-${clientId}]</span> ${message}`;

        if (data) {
            const dataDiv = document.createElement('div');
            dataDiv.className = 'message-data';
            dataDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            div.appendChild(dataDiv);
        }

        document.getElementById('log').appendChild(div);
        document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }

    function clearLog() {
        document.getElementById('log').innerHTML = '';
        log('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }

    function getTimestamp() {
        return Date.now();
    }

    function generateRequestId() {
        const now = new Date();
        return now.getHours().toString().padStart(2, '0') +
            now.getMinutes().toString().padStart(2, '0') +
            now.getSeconds().toString().padStart(2, '0');
    }

    function sendMessage(data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            const jsonStr = JSON.stringify(data);
            ws.send(jsonStr);
            log(`å‘é€æ¶ˆæ¯ â¡ï¸`, 'info', data);
            return true;
        } else {
            log('æ— æ³•å‘é€æ¶ˆæ¯: WebSocket æœªè¿æ¥', 'error');
            return false;
        }
    }

    function startPing() {
        stopPing();
        pingInterval = setInterval(() => {
            const ping = {
                request_id: generateRequestId(),
                action: "ping",
                timestamp: getTimestamp()
            };
            sendMessage(ping);
        }, 30000);
    }

    function stopPing() {
        if (pingInterval) {
            clearInterval(pingInterval);
            pingInterval = null;
        }
    }

    function startClient() {
        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
            log('å®¢æˆ·ç«¯å·²åœ¨è¿æ¥æˆ–å·²è¿æ¥', 'warning');
            return;
        }

        isManualDisconnect = false;
        reconnectAttempts = 0;
        const wsUrl = document.getElementById('wsUrl').textContent;
        log(`æ­£åœ¨è¿æ¥ WebSocket: ${wsUrl}`, 'info');
        updateStatus('reconnecting');

        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            log('WebSocket è¿æ¥å·²å»ºç«‹ âœ…', 'success');
            updateStatus('connected');
            reconnectAttempts = 0;

            // å‘é€è®¢é˜…æ¶ˆæ¯
            const sub = {
                request_id: generateRequestId(),
                action: "subscribe",
                timestamp: getTimestamp(),
                params: {
                    topic: "topic1",
                    type: "test2"
                }
            };
            sendMessage(sub);

            startPing();
        };

        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                log(`æ”¶åˆ°æ¶ˆæ¯ ğŸ“©`, 'success', data);
            } catch (e) {
                log(`æ”¶åˆ°éJSONæ¶ˆæ¯`, 'info', event.data);
            }
        };

        ws.onerror = function(error) {
            log(`WebSocket é”™è¯¯: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            console.error('WebSocket Error:', error);
        };

        ws.onclose = function(event) {
            log(`WebSocket è¿æ¥å·²å…³é—­ (ä»£ç : ${event.code}, åŸå› : ${event.reason || 'æ— '})`, 'error');
            stopPing();

            if (!isManualDisconnect && reconnectAttempts < maxReconnectAttempts) {
                updateStatus('reconnecting', `å°†åœ¨ ${reconnectDelay/1000} ç§’åå°è¯•é‡è¿ (${reconnectAttempts + 1}/${maxReconnectAttempts})`);
                setTimeout(startClient, reconnectDelay);
                reconnectAttempts++;
            } else {
                updateStatus('disconnected');
            }
        };
    }

    function stopClient() {
        isManualDisconnect = true;
        if (ws) {
            ws.close();
            ws = null;
        }
        stopPing();
        log('å®¢æˆ·ç«¯å·²æ‰‹åŠ¨åœæ­¢ â¹ï¸', 'info');
        updateStatus('disconnected');
    }

    function simulateReconnect() {
        log('æ‰‹åŠ¨è§¦å‘é‡è¿...', 'warning');
        stopClient();
        setTimeout(startClient, 500);
    }
</script>
</body>
</html>